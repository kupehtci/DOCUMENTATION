#AWS 

# AWS - KMS or Key Management Service

**AWS KMS** or **Key Management Service** is a centralized encryption key management system. 
It lets you create, control and **manage cryptographic keys** used to encrypt data between AWS services and applications. 

They key characteristics of AWS KMS are: 
* **CMK** or **Customer Master Key**: master key created in KMS. Can be symmetric(AES-256) or asymmetric (RSA/ECC).
* **Key policies**: Indicates who can use or manage keys. (Access control mechanism)
* **IAM Integration**: Fine-grained permisions by allowing users or roles to use a key for encryption/decryption.
* **Automatic Key Rotation**: can automatically rotate CMKs yearly to improve security.
* **Audit** and **Logging**: Integrated with CloudTrail so can monitor who used a key and when. 
* **Envelope encryption**: KMS keys are used to encrypt data keys which encrypt the actual data sent. This improves security.
* **Cross-Region Replication**: Allows CMKs to be replicated across regions (For DR, backups or multi-region applications).
* **Integrated with many AWS Services**: Like S3, EBS, RDS, RedShift, Lambda, CloudTrail, Secrets Manager or SSM Parameter Store.

## What is a KMS Key? 

A **KMS Key** also known as Customer Master Key or CMK is a logical representation of an encryption Key that contains: 
* Key material (The actual key (Not visible))
* Key metadata (ID, Creation date, description and state)
* Key policies (who can use or manage the key)

There are different types of keys: 
* **AWS Managed Keys**: Created by AWS when enabled encryption
	* Names as `aws/{service-name}` like `aws/s3`.
	* No cost for the usage of the key, only API usage. 
	* Its automatically rotated once a year (Cannot disable this rotation).
	* Integrated with CloudTrail. 
	* Example: its created when S3 default encryption (SEE-KMS)
* **Customer Manager Keys**: you can create and manage this keys and have full control of the policies, enable and disable and also delete. 
	* Has a 1$ cost (Orientative) of 1 key per month plus the API usage. 
	* Optional rotation
	* Integrated with CloudTrail. 
	* Can have *scheduled deletion* like after 7 or 30 days waiting period. 
* **AWS Owned keys**: owned and managed by AWS
	* Are not visible to the users.
	* No cost, no control and no CloudTrail Logs. 
	* Example: Default S3 encryption (SEE-S3), where the keys and encryption is fully managed by AWS and you have no control over the keys used by AWS. 

Also can distinguish by origin of the **key material**: 
* **KMS AWS Generated**: AWS generated the key material using FIPS 140-2 HSMs
	* Most common and recommended. 
* **External generated**: you can import an external material key from outside AWS
	* Has more control but more responsibility as the Key material is exposed. 
* **AWS Cloud HSM**: key material generated by AWS CloudHSM cluster
	* Has a higher security assurance. 
* **External Key Store**: Key material stored outside AWS KMS, in an external key manager.
	* Common in hybrid environments. 

### Multi-Region key

A **Multi-Region** key is a set of KMS Keys that share: 
* **Same Key Material** or identical cryptographic key across different AWS Regions.
* **Same Key ID** or name

And differ in: 
* **Different ARN**[^arn] being region-specific in each key, example: 
	* arn:aws:kms:<span style="color:red">eu-west-1:123456</span>:key/<span style="color:DodgerBlue">mrk-abc123def456</span>
	* arn:aws:kms:<span style="color:red">ap-southeast-1:123456</span>:key/<span style="color:DodgerBlue">mrk-abc123def456</span>

Allowing this keys to be **interchangeable**, so data encrypted in one region can be decrypted in another region using one of the other key of the set.

There is one **Primary key** and the other are known as **Replica Keys**: 
* Each replica key can be promoted to primary.
* If primary key is rotated, replica keys get also rotated. 
* Replica keys needs to be deleted first before deleting primary key. 

## Envelope Encryption

**Envelope encryption** implies that only the small data key is passed around, not the master key.

1. You create a **CMK** in KMS.    
2. Generate a **data key** from the CMK.
3. Use the **data key** to encrypt your data locally or in a service (like S3 or DynamoDB).
4. KMS stores the **CMK securely**, handles **key lifecycle**, and **decrypts data keys** when requested by authorized users/services.

### Usage cases

The most common usage cases of KMS Service are: 
* **Encrypt S3 buckets**: use KMS CMK for server side encryption.
* **Encrypt EBS Volumes**: Attach CMK to volumes for data-at-rest encryption.
* **Encrypt RDS / RedShift / DynamoDB data**: handle encryption keys automatically.
* **Secure Secrets Manager or Parameter Store Secrets**: encrypts the secrets at rest.
* **Digital Signatures and verification**: Asymmetric CMKs allow signing and verifying messages. 

### Integrations

The different services that KMS is integrated with: 

* CloudTrail: monitor events of key usage, useful for auditing all key usage for auditing requirements (PCI, HIPAA and others). 

## Key policy

A Key policy is an IAM Policy [^iam] that controls the access to it: 

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "Enable IAM User Permissions",
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::123456789012:root"
      },
      "Action": "kms:*",
      "Resource": "*"
    },
    {
      "Sid": "Allow use of the key",
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::123456789012:role/ExampleAppRole"
      },
      "Action": [
        "kms:Decrypt",
        "kms:DescribeKey"
      ],
      "Resource": "*"
    }
  ]
}
```

The previous example allow the root account to have all permissions over the key and allow an `ExampleAppRole` to decrypt and use the key for decrypt an AWS Resource. 

# Notes

* KMS keys never leave the KMS service unencrypted, so can't be exported. 
* AWS managed keys are free (Key storage) and both types of keys have API usage cost. 
* The key's policies control access is a combination of the Key policy and an IAM poicy.
* Envelope encryption is the common standard pattern usage. 


---

[^iam]: IAM or Identity Account Management is the AWS Service for identity and permissions management [[AWS - IAM]]. Permissions are defined through policies [[AWS - IAM Policies]]. 